<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IDC Calyptapis Glyph Review</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        h1 {
            text-align: center;
            margin-bottom: 10px;
        }
        .progress-bar {
            background: #333;
            border-radius: 10px;
            height: 24px;
            margin: 0 auto 20px;
            max-width: 600px;
            overflow: hidden;
            position: relative;
        }
        .progress-fill {
            background: linear-gradient(90deg, #4ade80, #22c55e);
            height: 100%;
            transition: width 0.3s ease;
        }
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            font-size: 12px;
        }
        .weight-section {
            margin-bottom: 30px;
        }
        .weight-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #444;
        }
        .weight-title {
            font-size: 1.4em;
            font-weight: bold;
            min-width: 120px;
        }
        .weight-progress {
            font-size: 0.9em;
            color: #888;
        }
        .glyph-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .glyph-cell {
            width: 70px;
            height: 70px;
            background: #2a2a4a;
            border: 2px solid #444;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .glyph-cell:hover {
            border-color: #666;
            transform: scale(1.05);
        }
        .glyph-cell.reviewed-up {
            border-color: #22c55e;
            background: #1a3a2a;
        }
        .glyph-cell.reviewed-down {
            border-color: #ef4444;
            background: #3a1a1a;
        }
        .glyph-cell img {
            max-width: 55px;
            max-height: 55px;
            filter: invert(1);
        }
        .glyph-cell .check-mark {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 14px;
        }
        .glyph-cell .glyph-id {
            position: absolute;
            bottom: 1px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 8px;
            color: #666;
        }

        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal {
            background: #2a2a4a;
            border-radius: 16px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-title {
            font-size: 1.5em;
            font-weight: bold;
        }
        .close-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
        }
        .close-btn:hover {
            color: #fff;
        }
        .modal-content {
            display: flex;
            gap: 30px;
        }
        .preview-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .preview-large {
            width: 200px;
            height: 200px;
            background: #1a1a2e;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }
        .preview-large img {
            max-width: 180px;
            max-height: 180px;
            filter: invert(1);
        }
        .weight-previews {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .weight-preview {
            width: 50px;
            height: 50px;
            background: #1a1a2e;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .weight-preview.active {
            border-color: #4ade80;
        }
        .weight-preview img {
            max-width: 40px;
            max-height: 40px;
            filter: invert(1);
        }
        .weight-preview-label {
            font-size: 8px;
            text-align: center;
            margin-top: 2px;
            color: #888;
        }
        .review-area {
            flex: 1;
        }
        .sentiment-buttons {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .sentiment-btn {
            flex: 1;
            padding: 20px;
            border: 3px solid #444;
            border-radius: 12px;
            background: #1a1a2e;
            cursor: pointer;
            font-size: 40px;
            transition: all 0.2s ease;
        }
        .sentiment-btn:hover {
            transform: scale(1.05);
        }
        .sentiment-btn.up:hover, .sentiment-btn.up.selected {
            border-color: #22c55e;
            background: #1a3a2a;
        }
        .sentiment-btn.down:hover, .sentiment-btn.down.selected {
            border-color: #ef4444;
            background: #3a1a1a;
        }
        .comment-area {
            margin-bottom: 20px;
        }
        .comment-area label {
            display: block;
            margin-bottom: 8px;
            color: #888;
        }
        .comment-area textarea {
            width: 100%;
            height: 100px;
            background: #1a1a2e;
            border: 2px solid #444;
            border-radius: 8px;
            color: #eee;
            padding: 10px;
            font-family: inherit;
            resize: vertical;
        }
        .comment-area textarea:focus {
            outline: none;
            border-color: #666;
        }
        .save-status {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #333;
            color: #888;
        }
        .save-status.saved {
            background: #1a3a2a;
            color: #4ade80;
        }
        .save-status.saving {
            background: #2a3a4a;
            color: #60a5fa;
        }
        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .nav-btn {
            flex: 1;
            padding: 10px;
            background: #444;
            border: none;
            border-radius: 6px;
            color: #eee;
            cursor: pointer;
        }
        .nav-btn:hover {
            background: #555;
        }
        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .current-review-status {
            text-align: center;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
            font-size: 14px;
        }
        .current-review-status.has-review {
            background: #2a3a4a;
        }
    </style>
</head>
<body>
    <h1>IDC Calyptapis Glyph Review</h1>
    <p style="text-align: center; color: #888; margin-bottom: 20px;">Design Consistency Assessment</p>

    <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
        <div class="progress-text" id="progressText">Loading...</div>
    </div>

    <div id="glyphContainer"></div>

    <!-- Review Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Review Glyph</div>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-content">
                <div class="preview-area">
                    <div class="preview-large">
                        <img id="previewImage" src="" alt="Glyph preview">
                    </div>
                    <div class="weight-previews" id="weightPreviews"></div>
                </div>
                <div class="review-area">
                    <div class="current-review-status" id="currentReviewStatus"></div>
                    <div class="sentiment-buttons">
                        <button class="sentiment-btn up" onclick="selectSentiment('up')">&#128077;</button>
                        <button class="sentiment-btn down" onclick="selectSentiment('down')">&#128078;</button>
                    </div>
                    <div class="comment-area">
                        <label for="commentInput">Optional comment (autosaves on blur):</label>
                        <textarea id="commentInput" placeholder="Notes on design consistency..."></textarea>
                    </div>
                    <div class="save-status" id="saveStatus">Select thumbs up or down to review</div>
                    <div class="nav-buttons">
                        <button class="nav-btn" id="prevBtn" onclick="navigateGlyph(-1)">&#8592; Previous</button>
                        <button class="nav-btn" id="nextBtn" onclick="navigateGlyph(1)">Next &#8594;</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const WEIGHTS = ["UltraLight", "Light", "Normal", "SemiBold", "Bold", "Black"];
        let glyphData = {};
        let reviews = {};
        let currentGlyph = null;
        let currentWeight = null;
        let selectedSentiment = null;
        let allGlyphs = []; // Flat list for navigation

        async function init() {
            const [glyphsResponse, reviewsResponse] = await Promise.all([
                fetch('/api/glyphs'),
                fetch('/api/reviews')
            ]);
            glyphData = await glyphsResponse.json();
            const reviewData = await reviewsResponse.json();
            reviews = reviewData.reviews || {};

            buildGlyphList();
            renderGlyphs();
            updateProgress();
        }

        function buildGlyphList() {
            allGlyphs = [];
            for (const weight of WEIGHTS) {
                if (glyphData[weight]) {
                    for (const glyph of glyphData[weight]) {
                        allGlyphs.push({ weight, glyph });
                    }
                }
            }
        }

        function renderGlyphs() {
            const container = document.getElementById('glyphContainer');
            container.innerHTML = '';

            for (const weight of WEIGHTS) {
                const glyphs = glyphData[weight] || [];
                const reviewedCount = glyphs.filter(g => reviews[`${weight}/${g}`]).length;

                const section = document.createElement('div');
                section.className = 'weight-section';
                section.innerHTML = `
                    <div class="weight-header">
                        <div class="weight-title">${weight}</div>
                        <div class="weight-progress">${reviewedCount} / ${glyphs.length} reviewed</div>
                    </div>
                    <div class="glyph-grid" id="grid-${weight}"></div>
                `;
                container.appendChild(section);

                const grid = section.querySelector('.glyph-grid');
                for (const glyph of glyphs) {
                    const review = reviews[`${weight}/${glyph}`];
                    const cell = document.createElement('div');
                    cell.className = 'glyph-cell';
                    if (review) {
                        cell.classList.add(`reviewed-${review.sentiment}`);
                    }

                    const glyphId = glyph.replace('calyptapis-', '').replace('.svg', '');
                    cell.innerHTML = `
                        <img src="/svg/${weight}/${glyph}" alt="${glyph}">
                        ${review ? `<span class="check-mark">${review.sentiment === 'up' ? '&#10003;' : '&#10007;'}</span>` : ''}
                        <span class="glyph-id">${glyphId}</span>
                    `;
                    cell.onclick = () => openModal(weight, glyph);
                    grid.appendChild(cell);
                }
            }
        }

        function updateProgress() {
            const total = allGlyphs.length;
            const reviewed = Object.keys(reviews).length;
            const percent = total > 0 ? (reviewed / total) * 100 : 0;

            document.getElementById('progressFill').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = `${reviewed} / ${total} reviewed (${percent.toFixed(1)}%)`;
        }

        function openModal(weight, glyph) {
            currentWeight = weight;
            currentGlyph = glyph;
            selectedSentiment = null;

            const glyphId = glyph.replace('calyptapis-', '').replace('.svg', '');
            document.getElementById('modalTitle').textContent = `Review: ${glyphId} (${weight})`;
            document.getElementById('previewImage').src = `/svg/${weight}/${glyph}`;

            // Show existing review if any
            const existingReview = reviews[`${weight}/${glyph}`];
            const statusEl = document.getElementById('currentReviewStatus');
            if (existingReview) {
                statusEl.className = 'current-review-status has-review';
                statusEl.innerHTML = `Previously reviewed: ${existingReview.sentiment === 'up' ? '&#128077;' : '&#128078;'}${existingReview.comment ? ` - "${existingReview.comment}"` : ''}`;
                selectedSentiment = existingReview.sentiment;
                document.getElementById('commentInput').value = existingReview.comment || '';
            } else {
                statusEl.className = 'current-review-status';
                statusEl.textContent = 'Not yet reviewed';
                document.getElementById('commentInput').value = '';
            }

            // Build weight comparison previews
            const previewsContainer = document.getElementById('weightPreviews');
            previewsContainer.innerHTML = '';
            for (const w of WEIGHTS) {
                if (glyphData[w] && glyphData[w].includes(glyph)) {
                    const preview = document.createElement('div');
                    preview.innerHTML = `
                        <div class="weight-preview ${w === weight ? 'active' : ''}" onclick="switchPreviewWeight('${w}')">
                            <img src="/svg/${w}/${glyph}" alt="${w}">
                        </div>
                        <div class="weight-preview-label">${w.substring(0, 4)}</div>
                    `;
                    previewsContainer.appendChild(preview);
                }
            }

            updateSentimentButtons();
            updateSaveStatus(existingReview ? 'saved' : null);
            updateNavButtons();

            document.getElementById('modalOverlay').classList.add('active');
        }

        function switchPreviewWeight(weight) {
            currentWeight = weight;
            const glyphId = currentGlyph.replace('calyptapis-', '').replace('.svg', '');
            document.getElementById('modalTitle').textContent = `Review: ${glyphId} (${weight})`;
            document.getElementById('previewImage').src = `/svg/${weight}/${currentGlyph}`;

            // Update active state on previews
            document.querySelectorAll('.weight-preview').forEach((el, i) => {
                el.classList.toggle('active', WEIGHTS[i] === weight);
            });

            // Load existing review for new weight
            const existingReview = reviews[`${weight}/${currentGlyph}`];
            const statusEl = document.getElementById('currentReviewStatus');
            if (existingReview) {
                statusEl.className = 'current-review-status has-review';
                statusEl.innerHTML = `Previously reviewed: ${existingReview.sentiment === 'up' ? '&#128077;' : '&#128078;'}${existingReview.comment ? ` - "${existingReview.comment}"` : ''}`;
                selectedSentiment = existingReview.sentiment;
                document.getElementById('commentInput').value = existingReview.comment || '';
            } else {
                statusEl.className = 'current-review-status';
                statusEl.textContent = 'Not yet reviewed';
                selectedSentiment = null;
                document.getElementById('commentInput').value = '';
            }

            updateSentimentButtons();
            updateSaveStatus(existingReview ? 'saved' : null);
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
            currentGlyph = null;
            currentWeight = null;
            selectedSentiment = null;
        }

        function selectSentiment(sentiment) {
            selectedSentiment = sentiment;
            updateSentimentButtons();
            saveReview(); // Autosave on sentiment selection
        }

        function updateSentimentButtons() {
            document.querySelectorAll('.sentiment-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            if (selectedSentiment) {
                document.querySelector(`.sentiment-btn.${selectedSentiment}`).classList.add('selected');
            }
        }

        function updateSaveStatus(status) {
            const el = document.getElementById('saveStatus');
            el.className = 'save-status';
            if (status === 'saved') {
                el.classList.add('saved');
                el.textContent = 'Saved';
            } else if (status === 'saving') {
                el.classList.add('saving');
                el.textContent = 'Saving...';
            } else {
                el.textContent = 'Select thumbs up or down to review';
            }
        }

        function updateNavButtons() {
            const currentIndex = allGlyphs.findIndex(
                g => g.weight === currentWeight && g.glyph === currentGlyph
            );
            document.getElementById('prevBtn').disabled = currentIndex <= 0;
            document.getElementById('nextBtn').disabled = currentIndex >= allGlyphs.length - 1;
        }

        function navigateGlyph(direction) {
            const currentIndex = allGlyphs.findIndex(
                g => g.weight === currentWeight && g.glyph === currentGlyph
            );
            const newIndex = currentIndex + direction;
            if (newIndex >= 0 && newIndex < allGlyphs.length) {
                const next = allGlyphs[newIndex];
                openModal(next.weight, next.glyph);
            }
        }

        async function saveReview() {
            if (!selectedSentiment || !currentGlyph || !currentWeight) return;

            updateSaveStatus('saving');
            const comment = document.getElementById('commentInput').value.trim();

            const response = await fetch('/api/reviews', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    weight: currentWeight,
                    glyph: currentGlyph,
                    sentiment: selectedSentiment,
                    comment: comment
                })
            });

            if (response.ok) {
                reviews[`${currentWeight}/${currentGlyph}`] = {
                    weight: currentWeight,
                    glyph: currentGlyph,
                    sentiment: selectedSentiment,
                    comment: comment
                };
                renderGlyphs();
                updateProgress();
                updateSaveStatus('saved');

                // Update the status display
                const statusEl = document.getElementById('currentReviewStatus');
                statusEl.className = 'current-review-status has-review';
                statusEl.innerHTML = `Reviewed: ${selectedSentiment === 'up' ? '&#128077;' : '&#128078;'}${comment ? ` - "${comment}"` : ''}`;
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (!document.getElementById('modalOverlay').classList.contains('active')) return;
            if (e.target.tagName === 'TEXTAREA') return;

            switch (e.key) {
                case 'ArrowLeft':
                    navigateGlyph(-1);
                    break;
                case 'ArrowRight':
                    navigateGlyph(1);
                    break;
                case 'ArrowUp':
                case '1':
                    selectSentiment('up');
                    break;
                case 'ArrowDown':
                case '2':
                    selectSentiment('down');
                    break;
                case 'Escape':
                    closeModal();
                    break;
            }
        });

        // Autosave comment on blur
        document.getElementById('commentInput').addEventListener('blur', () => {
            if (selectedSentiment) {
                saveReview();
            }
        });

        init();
    </script>
</body>
</html>
